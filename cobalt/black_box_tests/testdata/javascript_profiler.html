<!DOCTYPE html>

<head>
  <title>JavaScript Profiler Test</title>
  <script async src='black_box_js_test_utils.js'></script>
</head>

<body>
  <script type="application/javascript">
    // Function to check if a number is prime
    const isPrime = (num) => {
      if (num <= 1) return false;
      if (num === 2) return true;
      if (num % 2 === 0) return false;

      const sqrtNum = Math.sqrt(num);
      for (let i = 3; i <= sqrtNum; i += 2) {
        if (num % i === 0) {
          return false;
        }
      }
      return true;
    }

    const testPrimeProfiler = async () => {
      const profiler = new Profiler({ sampleInterval: 10 /**ms**/, maxBufferSize: 10000 /**number of samples*/ });
      const start = performance.now();

      for (let i = 0; i < 1000; i++) {
        isPrime(i);
      }

      const duration = performance.now() - start;
      const trace = await profiler.stop();
      const traceJson = JSON.stringify({
        duration,
        trace,
      });
    };

    const testSampleBufferFullProfiler = async () => {
      const profiler = new Profiler({ sampleInterval: 10 /**ms**/, maxBufferSize: 100 /**number of samples*/ });
      let running = true;
      profiler.addEventListener('samplebufferfull', () => {
        running = false;
        profiler.stop();
      });

      for (let i = 0; i < 10000000 && running; i++) {
        isPrime(i);
      }
    };

    /**
      * Creates a new Profiler and then deletes it before the sample buffer is full.
      * Expects the SampleBuffer to be full and the callback to be executed.
    */
    const testAbruptGarbageCollection = async () => {
      const promise = new Promise((resolve, reject) => {
        const profiler = new Profiler({ maxBufferSize: 100, sampleInterval: 10 });
        profiler.addEventListener('samplebufferfull', () => {
          resolve();
        });
        // Force garbage collection.
        delete profiler;
        setTimeout(() => {
          reject('SampleBufferFull event was not fired');
        }, 1000 /*ms*/);
      });

      await promise.then(() => {

      }).catch(() => {
      });
    };

    window.addEventListener('load', async () => {
      setupFinished();
      // Test Case 1: Prime Profiler
      // await testPrimeProfiler();
      // Test Case 2: SampleBufferFull Profiler
      // await testSampleBufferFullProfiler();
      // Test Case 3:
      //await testAbruptGarbageCollection();
      assertTrue(true, "Ayyy")
      onEndTest();
    });
  </script>
</body>
